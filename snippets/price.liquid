{% doc %}
  This snippet is used to render a product card.
  It is used in the product block,featured product block, and the product card block.

  @param {product} product_resource - The product to render
  @param {boolean} [show_unit_price] - Whether to show the unit price
  @param {boolean} [show_sale_price_first] - Whether to show the sale price first
{% enddoc %}

{%- liquid
  assign show_unit_price = show_unit_price | default: false
  assign show_sale_price_first = show_sale_price_first | default: false
  assign selected_variant = product_resource.selected_or_first_available_variant
  assign price = selected_variant.price
  assign compare_at_price = selected_variant.compare_at_price

  if product_resource == blank and request.design_mode
    assign price = 1999
  endif

  # Checks if product handle matches the closest product's handle (i.e. product page)
  # and if the currency code is enabled for product pages
  if product.handle == closest.product.handle and settings.currency_code_enabled_product_pages
    assign price = price | money_with_currency
    assign compare_at_price = compare_at_price | money_with_currency

    # Checks if product handle does not match the closest product's handle (i.e. product card)
    # and if the currency code is enabled for product cards
  elsif product.handle != closest.product.handle and settings.currency_code_enabled_product_cards
    assign price = price | money_with_currency
    assign compare_at_price = compare_at_price | money_with_currency

  else
    assign price = price | money
    assign compare_at_price = compare_at_price | money
  endif

  # Calcula o preço com 5% de desconto para PIX
  assign pix_discount = 0.05
  assign pix_price_cents = selected_variant.price | times: 100 | minus: pix_discount | divided_by: 100
  assign pix_price = selected_variant.price | times: 0.95
-%}

<div class="price__prod" ref="priceContainer">
  {% if show_sale_price_first == false and compare_at_price > price %}
    <s class="compare-at-price">{{ compare_at_price }}</s>
  {% endif %}

  <span class="price">{{ price | default: '&nbsp;' }}</span>

  {% if show_sale_price_first == true %}
    <s class="compare-at-price">{{ compare_at_price }}</s>
  {% endif %}

  {%- comment -%}
    Calcula parcelamento com valor mínimo de R$ 100,00 por parcela
    Valor mínimo em centavos: 10000 (R$ 100,00)
  {%- endcomment -%}
  {%- assign min_installment_value = 10000 -%}
  {%- assign max_installments = 6 -%}
  {%- assign installments = max_installments -%}
  
  {%- comment -%} Calcula o número máximo de parcelas respeitando o mínimo {%- endcomment -%}
  {%- for i in (1..max_installments) -%}
    {%- assign test_installment = selected_variant.price | divided_by: i -%}
    {%- if test_installment >= min_installment_value -%}
      {%- assign installments = i -%}
    {%- endif -%}
  {%- endfor -%}

  {%- comment -%} Se o valor total for menor que o mínimo, mostra apenas à vista {%- endcomment -%}
  {%- if selected_variant.price >= min_installment_value -%}
    {%- assign installment_price = selected_variant.price | divided_by: installments -%}
    <span class="installment-price">
      {{ installments }}x de {{ installment_price | money }} s/ juros
    </span>
  {%- endif -%}

  {%- comment -%} Exibe o preço com desconto no PIX {%- endcomment -%}
  <span class="pix-price">
    {{ pix_price | money }} <small>(5% de desconto no PIX)</small>
  </span>

  {%- if selected_variant.unit_price and show_unit_price %}
    {%- liquid
      if product.handle == closest.product.handle and settings.currency_code_enabled_product_pages
        assign unit_price = selected_variant.unit_price | money_with_currency
      elsif product.handle != closest.product.handle and settings.currency_code_enabled_product_cards
        assign unit_price = selected_variant.unit_price | money_with_currency
      else
        assign unit_price = selected_variant.unit_price | money
      endif
    -%}
    {% render 'unit-price', variant: selected_variant, price: unit_price %}
  {%- endif -%}
</div>